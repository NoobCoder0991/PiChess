<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" />
    <link rel="stylesheet" href="../../src/CSS_Files/play.css">


</head>

<style>
    @import url("https://fonts.googleapis.com/css2?family=Exo+2&display=swap");

    @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap');
    @import url("https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap");
    @import url("https://fonts.googleapis.com/css2?family=Exo+2&display=swap");

    @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Roboto+Slab:wght@100..900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Mukta:wght@200;300;400;500;600;700;800&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap');


    /* Hello world */
    :root {
        --body-color: #312e2b;
        --primary: rgb(23, 23, 23);
        --default-color: #bababa;
        --accent: rgb(205, 40, 18);
        --secondary: #5f8805;
        --square-width: 2.5vw;
        --square-width-mobile: 10vw;
        --square-width-intermediate: 4vw;

    }

    ::-webkit-scrollbar {
        display: none;
        width: 3px;
    }

    body {
        background-color: var(--body-color);
        color: var(--default-color);
        font-family: "Mukta", sans-serif;
        font-optical-sizing: auto;
        font-weight: 400;
        font-style: normal;
        margin: 0;
        padding: 0;
        height: 100vh;
        width: 100vw;
        overflow: auto;
        display: flex;
        flex-direction: column;
        /* justify-content: center; */
        z-index: 0;
        user-select: none;

    }

    .main {
        /* width: 60%; */
        padding: 1vw;
        display: flex;
        /* align-self: center; */
        flex-direction: column;
    }

    .completed-games {
        align-self: center;
        width: 60%;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
    }

    .input {
        background-color: var(--body-color);
        outline: none;
        box-shadow: none;
    }

    .pages {
        display: flex;
    }

    .page {
        padding: 0 4%;
        cursor: pointer;
    }

    .page:hover {
        background-color: rgb(51, 46, 46);
    }

    .active-page {
        background-color: rgb(78, 71, 71);
        background-color: var(--secondary);
    }

    .active-page:hover {
        background-color: rgb(78, 71, 71);
    }

    .completed-games {
        padding: 0;
    }

    .dummy-rows {
        display: none;
    }

    .dummy-row {
        width: 100%;
        height: 10vh;
        border-bottom: 1px solid grey;
        background-color: rgba(0, 0, 0, 0.05);
        animation: blink 2s linear infinite;
    }

    .profile {
        display: flex;
    }

    .profile>div {
        margin: 0 1%;
    }

    .profile-title {
        color: gold;
        font-weight: bold;
    }

    @keyframes blink {
        0% {
            background-color: rgba(0, 0, 0, 0.05);
        }

        25% {
            background-color: rgba(0, 0, 0, 0.1);

        }

        50% {
            background-color: rgba(0, 0, 0, 0.2);

        }

        75% {
            background-color: rgba(0, 0, 0, 0.25);

        }

        100% {

            background-color: rgba(0, 0, 0, 0.1);
        }

    }
</style>

<body>

    <div class="main">
        <div class="mini-board-wrapper">
            <div class="mini-board">
                <div class="mini-file">
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                </div>
                <div class="mini-file">
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                </div>
                <div class="mini-file">
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                </div>
                <div class="mini-file">
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                </div>
                <div class="mini-file">
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                </div>
                <div class="mini-file">
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                </div>
                <div class="mini-file">
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                </div>
                <div class="mini-file">
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                    <div class="mini-square mini-dark-square"></div>
                    <div class="mini-square mini-light-square"></div>
                </div>


            </div>
        </div>
        <div class="header">
            <div class="left-header">
                <div class="logo">
                    <i class="fas fa-chess"></i>
                    PiChess.org

                </div>

            </div>
        </div>
        <div class="completed-games card">
            <div class="completed-games-title">
                <div><i class="fas fa-chess-board"></i> My Games</div>
                <div class="profile" onclick="window.location.href='/profile'">
                    <div class="profile-title"></div>
                    <div class="profile-name"></div>
                </div>
                <!-- <div class="completed-games-search"><input class="input" type="text" placeholder="search-game"></div> -->
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Players</th>
                            <th>Result</th>
                            <th>Accuracy</th>
                            <th>Moves</th>
                            <th>Date</th>
                            <!-- <th>Download</th> -->
                        </tr>
                    </thead>
                    <tbody class="table-body">
                        <!-- Table rows -->


                    </tbody>
                </table>
                <div class="dummy-rows">
                    <div class="dummy-row"></div>
                    <div class="dummy-row"></div>
                    <div class="dummy-row"></div>
                    <div class="dummy-row"></div>

                </div>
            </div>
            <div class="pages">
            </div>
        </div>




    </div>

    <div class="advanced-footer">
        <div class="footer-links">
            <a href="" class="footer-link">Help</a> |
            <a href="" class="footer-link">Chess Terms</a> |
            <a href="" class="footer-link">About</a> |
            <a href="" class="footer-link">Students</a> |
            <a href="" class="footer-link">Jobs</a> |
            <a href="" class="footer-link">Developers</a> |
            <a href="" class="footer-link">User Agreement</a> |
            <a href="" class="footer-link">Privace</a> |
            <a href="" class="footer-link">Fair Play</a> |
            <a href="" class="footer-link">Partners</a> |
            <a href="" class="footer-link">PiChess.org &copy; 2023-2024</a>
        </div>

        <div class="footer-options">
            <div class="footer-download-options">
                <a href="" class="footer-download-option footer-option"><i class="fab fa-apple"></i>
                </a>
                <a href="" class="footer-download-option footer-option"><i class="fab fa-android"></i></a>

            </div>
            <div class="footer-contact-options">
                <a href=""><i class="footer-option fab fa-facebook"></i></a>
                <a href=""><i class="footer-option fab fa-twitter"></i></a>
                <a href=""><i class="footer-option fab fa-instagram"></i></a>
                <a href=""><i class="footer-option fab fa-youtube"></i></a>
                <a href=""><i class="footer-option fab fa-github"></i></a>
            </div>
        </div>
    </div>





</body>


<script>


    const url = window.location.href;
    const urlObj = new URL(url);
    const params = new URLSearchParams(urlObj.search);

    const page = parseInt(params.get('page'))



    fetch("/fetch-games", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ page })
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`)
            }
            return response.json()
        })
        .then(data => {

            document.querySelector(".profile-name").innerHTML = data.username
            document.querySelector(".profile-title").innerHTML = data.title
            const games = data.games;
            const len = data.gamesLength
            const maxPages = Math.ceil(len / 5);

            let arr = [1, Math.max(1, page - 2), Math.max(1, page - 1), page, Math.min(maxPages, page + 1), Math.min(maxPages, page + 2), maxPages];
            arr = getDistinctElements(arr);

            for (let i = 0; i < arr.length; i++) {
                let pageDiv = document.createElement('div');
                pageDiv.classList.add("page")
                pageDiv.innerHTML = arr[i];
                if (arr[i] == page) {

                    pageDiv.classList.add('active-page')
                }
                pageDiv.addEventListener('click', e => {
                    window.location.href = '/games?page=' + arr[i];

                })
                document.getElementsByClassName('pages')[0].appendChild(pageDiv)

            }



            for (let i = games.length - 1; i >= 0; i--) {
                let completedGame = games[i];
                let gameInfo = JSON.parse(completedGame);
                let moveCount = parseInt((gameInfo.game.split(" ").length - 1) / 2)
                let date = gameInfo.date
                let gameElement;
                let winner = gameInfo.winner;

                if (winner == 1) {
                    gameElement = createTableRow(gameInfo.winnerUsername, gameInfo.loserUsername, gameInfo.winnerRating, gameInfo.loserRating, moveCount, date, 1, gameInfo.perspective, gameInfo.resultFen, i)
                }
                else if (winner == -1) {
                    gameElement = createTableRow(gameInfo.loserUsername, gameInfo.winnerUsername, gameInfo.loserRating, gameInfo.winnerRating, moveCount, date, -1, gameInfo.perspective, gameInfo.resultFen, i)

                }
                else {
                    gameElement = createTableRow(gameInfo.winnerUsername, gameInfo.loserUsername, gameInfo.winnerRating, gameInfo.loserRating, moveCount, date, 0, gameInfo.perspective, gameInfo.resultFen, i)

                }



                document.getElementsByClassName('table-body')[0].appendChild(gameElement);
                gameElement.addEventListener('click', e => {

                    sendPostRequest('/recape-game', { gameInfo })
                        .then(data => {
                            if (data.ok) {
                                window.location.href = data.url
                            }

                        })
                })


            }
        })
        .catch(err => {
            console.log("Error:", err)
        })





    function createTableRow(whiteName, blackName, whiteRate, blackRate, moveCount, date, winner, perspective, resutlFen, index) {

        // Create the table row element
        var tableRow = document.createElement("tr");
        tableRow.classList.add("table-row");

        // Create the first table data cell
        var td1 = document.createElement("td");

        // Create the completed game profiles div
        var completedGameProfiles = document.createElement("div");
        completedGameProfiles.classList.add("completed-game-profiles");

        // Create the white profile div
        var whiteProfile = document.createElement("div");
        whiteProfile.classList.add("white-profile");

        // Create the white flag div
        var whiteFlag = document.createElement("div");
        whiteFlag.classList.add("white-flag");
        if (winner == 1) {
            whiteFlag.classList.add("winner-flag");

        }
        else if (winner == -1) {
            whiteFlag.classList.add("loser-flag");

        }

        // Create the white username div
        var whiteUsername = document.createElement("div");
        whiteUsername.classList.add("white-username");
        whiteUsername.textContent = whiteName;

        // Create the white rating div
        var whiteRating = document.createElement("div");
        whiteRating.classList.add("white-rating");
        whiteRating.textContent = "(" + whiteRate + ")";

        // Append elements to white profile
        whiteProfile.appendChild(whiteFlag);
        whiteProfile.appendChild(whiteUsername);
        whiteProfile.appendChild(whiteRating);

        // Create the black profile div
        var blackProfile = document.createElement("div");
        blackProfile.classList.add("black-profile");

        // Create the black flag div
        var blackFlag = document.createElement("div");
        blackFlag.classList.add("black-flag");
        if (winner == 1) {

            blackFlag.classList.add("loser-flag");
        }
        else if (winner == -1) {

            blackFlag.classList.add("winner-flag");
        }

        // Create the black username div
        var blackUsername = document.createElement("div");
        blackUsername.classList.add("white-username");
        blackUsername.textContent = blackName;

        // Create the black rating div
        var blackRating = document.createElement("div");
        blackRating.classList.add("white-rating");
        blackRating.textContent = "(" + blackRate + ")";

        // Append elements to black profile
        blackProfile.appendChild(blackFlag);
        blackProfile.appendChild(blackUsername);
        blackProfile.appendChild(blackRating);

        // Append white and black profiles to completed game profiles
        completedGameProfiles.appendChild(whiteProfile);
        completedGameProfiles.appendChild(blackProfile);

        // Append completed game profiles to table data cell 1
        td1.appendChild(completedGameProfiles);

        // Create the second table data cell
        var td2 = document.createElement("td");

        // Create the completed game result div
        var completedGameResult = document.createElement("div");
        completedGameResult.classList.add("completed-game-result");

        // Create the inner div for result and status
        var resultStatusDiv = document.createElement("div");
        resultStatusDiv.style.cssText = "display: flex;flex-direction: column;justify-content: center;align-items: center;";

        // Create the white result div
        var whiteResult = document.createElement("div");
        whiteResult.classList.add("white-result");
        if (winner == 1) {

            whiteResult.textContent = "1";
        }
        else if (winner == -1) {
            whiteResult.textContent = "0";

        }
        else {

            whiteResult.innerHTML = "&frac12";
        }

        // Create the black result div
        var blackResult = document.createElement("div");
        blackResult.classList.add("black-result");
        if (winner == -1) {

            blackResult.textContent = "1";
        }
        else if (winner == 1) {

            blackResult.textContent = "0";
        }
        else {

            blackResult.innerHTML = "&frac12";
        }

        // Append white and black result to result status div
        resultStatusDiv.appendChild(whiteResult);
        resultStatusDiv.appendChild(blackResult);

        // Create the my status div
        var myStatus = document.createElement("div");
        myStatus.classList.add("status");
        if (winner == perspective) {

            myStatus.classList.add("winner-status");
            myStatus.innerHTML = "<i class='fas fa-plus'></i>";
        }
        else if (winner) {

            myStatus.classList.add("loser-status");
            myStatus.innerHTML = "<i class='fas fa-minus'></i>";
        }
        else {
            myStatus.classList.add("draw-status");
            myStatus.innerHTML = "<i class='fas fa-equals'></i>";

        }

        // Append result status div and my status to completed game result
        completedGameResult.appendChild(resultStatusDiv);
        completedGameResult.appendChild(myStatus);

        // Append completed game result to table data cell 2
        td2.appendChild(completedGameResult);

        // Create the third table data cell
        var td3 = document.createElement("td");

        // Create the completed game accuracy div
        var completedGameAccuracy = document.createElement("div");
        completedGameAccuracy.classList.add("completed-game-accuracy");

        // Create the white accuracy div
        var whiteAccuracy = document.createElement("div");
        whiteAccuracy.classList.add("white-accuracy");
        whiteAccuracy.textContent = "NA";

        // Create the black accuracy div
        var blackAccuracy = document.createElement("div");
        blackAccuracy.classList.add("black-accuracy");
        blackAccuracy.textContent = "NA";

        // Append white and black accuracy to completed game accuracy
        completedGameAccuracy.appendChild(whiteAccuracy);
        completedGameAccuracy.appendChild(blackAccuracy);

        // Append completed game accuracy to table data cell 3
        td3.appendChild(completedGameAccuracy);

        // Create the fourth table data cell
        var td4 = document.createElement("td");
        td4.textContent = moveCount;

        // Create the fifth table data cell
        var td5 = document.createElement("td");
        td5.innerHTML = date;


        var resultBoard = createMiniBoard(resutlFen, perspective)

        // Append table data cells to table row
        tableRow.appendChild(td1);
        tableRow.appendChild(td2);
        tableRow.appendChild(td3);
        tableRow.appendChild(td4);
        tableRow.appendChild(td5);
        tableRow.appendChild(resultBoard)
        tableRow.addEventListener('mouseover', e => {
            resultBoard.style.display = 'flex'
        })
        tableRow.addEventListener('mouseout', e => {
            resultBoard.style.display = 'none'
        })

        // Append table row to table body or any other parent element
        return tableRow;
    }

    function createMiniBoard(fen, perspective) {

        let board = generateBoard(fen, perspective);

        for (let i = 0; i < 64; i++) {
            let sq = document.getElementsByClassName('mini-square')[i];
            if (board[i]) {
                let piece = document.createElement('img');
                piece.classList.add('mini-piece')
                piece.src = '../../assets/image-files/piece-images/' + board[i] + '.png';

                if (sq.firstChild) {

                    sq.removeChild(sq.firstChild);
                }
                sq.appendChild(piece)
            }
            else {
                if (sq.firstChild) {

                    sq.removeChild(sq.firstChild);
                }

            }
        }
        return document.getElementsByClassName('mini-board-wrapper')[0].cloneNode(true)

    }



    function generateBoard(str, perspective) {
        let board = [];
        let map = {
            R: 6,
            N: 3,
            B: 4,
            Q: 10,
            K: 2,
            P: 1,
            r: -6,
            n: -3,
            b: -4,
            q: -10,
            k: -2,
            p: -1,
        };
        let fragments = str.split(" ");

        let i = 0;

        for (char of fragments[0]) {
            if (map.hasOwnProperty(char)) {
                if (perspective == 1) {
                    board[i] = map[char];
                } else {
                    board[63 - i] = map[char];
                }
                i++;
            } else {
                let num = parseInt(char);

                for (j = 0; j < num; j++) {
                    if (perspective == 1) {
                        board[i] = 0;
                    } else {
                        board[63 - i] = 0;
                    }
                    i++;
                }
            }
        }



        return board;
    }

    async function sendPostRequest(url, postData) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Add any other headers if needed
                },
                body: JSON.stringify(postData)
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const responseData = await response.json();
            return responseData;
        } catch (error) {
            console.error('Error during POST request:', error);
            // You can handle the error here, e.g., display a message to the user
            throw error; // Rethrow the error to propagate it
        }
    }

    function getDistinctElements(arr) {
        const distinctSet = new Set(arr);
        return Array.from(distinctSet);
    }
</script>

</html>